---
title: GCP Cloud Storage Configuration
description: Learn how to configure GCP Cloud Storage as object storage for Appcircle server when installing using a Helm chart
tags:
  [
    self-hosted,
    gcp,
    cloud-storage
  ]
sidebar_position: 50
---

import NeedHelp from '@site/docs/_need-help.mdx';

## Overview

Appcircle server requires object storage to store various artifacts, including build logs and application binaries. By default, the Helm chart deploys MinIO as an in-cluster object storage solution. However, for production environments, it's recommended to use a more robust and scalable solution like Google Cloud Storage (GCS).

This guide will walk you through the process of configuring GCP Cloud Storage as your object storage backend for the Appcircle server. To use GCP Cloud Storage with Appcircle Server, you need to:

- Set up the necessary GCP credentials and permissions.
- Create the required GCS buckets.
- Configure the Appcircle server to use GCP Cloud Storage.

:::caution
GCP Cloud Storage configuration requires a fresh installation of Appcircle Server. If you have an existing installation with no data, you can uninstall and reinstall with GCP configuration. However, migration from MinIO to GCP Cloud Storage is not supported for installations with existing data.
:::

## Prerequisites

Before you begin, ensure you have the following prerequisites:

- A Google Cloud Platform (GCP) account with appropriate permissions to create and manage Cloud Storage buckets and IAM roles.
- The [Google Cloud SDK (gcloud)](https://cloud.google.com/sdk/docs/install) and [gsutil](https://cloud.google.com/storage/docs/gsutil_install) installed and configured on your machine.
- The Helm chart [installed](https://helm.sh/docs/intro/install/) and [configured](https://helm.sh/docs/intro/quickstart/) for your Kubernetes cluster.
- Basic understanding of GCP IAM, Cloud Storage, and Kubernetes concepts.

:::info
This guide assumes you have administrative access to your GCP project and Kubernetes cluster. If you're working in a restricted environment, ensure you have the necessary permissions before proceeding.
:::

## Create and Configure GCP Cloud Storage Buckets

### 1. Define Variables

Set the following variables on your terminal to configure your GCP Cloud Storage setup. These variables will be used throughout the configuration process to create buckets, set up IAM permissions, and configure the Appcircle server.

:::info
The `spacetech` is a sample organization name to make bucket names unique. You can use your own organization name instead of `spacetech`.
:::

```bash
ORG_NAME="spacetech" # Replace with your organization name
PROJECT_ID="my-gcp-project"  # Replace with your actual GCP project ID
BUCKET_PREFIX="appcircle-${ORG_NAME}" # Replace with your desired bucket prefix
LOCATION="us-east1"          # Or multi-region like "us"
SERVICE_ACCOUNT_NAME="appcircle-server" # Replace with your desired service account name
```

### 2. Create the required GCS buckets

To store the artifacts generated by the Appcircle server, you need to create the following GCS buckets.

- `${BUCKET_PREFIX}-temp`
- `${BUCKET_PREFIX}-build`
- `${BUCKET_PREFIX}-distribution`
- `${BUCKET_PREFIX}-storesubmit`
- `${BUCKET_PREFIX}-store`
- `${BUCKET_PREFIX}-agent-cache`
- `${BUCKET_PREFIX}-backup`
- `${BUCKET_PREFIX}-publish`

You can create the required GCS buckets using the following commands:

```bash
gsutil mb -l ${LOCATION} gs://${BUCKET_PREFIX}-temp/
gsutil mb -l ${LOCATION} gs://${BUCKET_PREFIX}-build/
gsutil mb -l ${LOCATION} gs://${BUCKET_PREFIX}-distribution/
gsutil mb -l ${LOCATION} gs://${BUCKET_PREFIX}-storesubmit/
gsutil mb -l ${LOCATION} gs://${BUCKET_PREFIX}-store/
gsutil mb -l ${LOCATION} gs://${BUCKET_PREFIX}-agent-cache/
gsutil mb -l ${LOCATION} gs://${BUCKET_PREFIX}-backup/
gsutil mb -l ${LOCATION} gs://${BUCKET_PREFIX}-publish/
```

:::caution
Ensure your bucket names follow GCS naming conventions:
    - 3-63 characters long
    - Lowercase letters, numbers, dots (.), and hyphens (-)
    - Must start and end with a letter or number
    - Must be DNS-compliant
:::

### 3. Configure CORS settings for the `temp` bucket

After creating the buckets, you should configure the CORS settings for the `temp` bucket to allow cross-origin requests from your Appcircle Server web UI.

:::caution
Replace `my.appcircle.spacetech.com` with your Appcircle Server web UI domain.
:::

Create a `appcircle-gcs-policy.json` file:

```bash
cat << 'EOF' > appcircle-gcs-policy.json
[
  {
    "origin": ["https://my.appcircle.spacetech.com"],
    "method": ["GET", "PUT", "POST", "DELETE", "HEAD"],
    "responseHeader": ["*"],
    "maxAgeSeconds": 3600
  }
]
EOF
```

Then apply it:

```bash
gsutil cors set appcircle-gcs-policy.json gs://${BUCKET_PREFIX}-temp
```

:::tip
- The CORS configuration above is specific to the `temp` bucket. Other buckets don't require CORS configuration as they are accessed server-side.
:::

### 4. Create a Service Account

Appcircle Server needs a service account with appropriate permissions to access the GCS buckets. Run the following command:

```bash
gcloud iam service-accounts create ${SERVICE_ACCOUNT_NAME} \
  --description="AppCircle GCS access service account" \
  --display-name="AppCircle Server"
```

### 5. Create a Custom Role (Optional: for least privilege)

To create a custom role with granular access, run the following command:

```bash
gcloud iam roles create AppcircleGCSRole \
  --project=$PROJECT_ID \
  --title="AppCircle GCS Role" \
  --description="For Appcircle Server to access GCS buckets" \
  --permissions="storage.objects.get,storage.objects.list,storage.objects.create,storage.objects.delete" \
  --stage=GA
```

### 6. Bind the Role to the Service Account

Bind per bucket (default GCP roles):

```bash
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_PREFIX}-temp \
  --member="serviceAccount:${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="projects/${PROJECT_ID}/roles/AppcircleGCSRole"
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_PREFIX}-build \
  --member="serviceAccount:${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="projects/${PROJECT_ID}/roles/AppcircleGCSRole"
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_PREFIX}-distribution \
  --member="serviceAccount:${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="projects/${PROJECT_ID}/roles/AppcircleGCSRole"
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_PREFIX}-storesubmit \
  --member="serviceAccount:${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="projects/${PROJECT_ID}/roles/AppcircleGCSRole"
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_PREFIX}-store \
  --member="serviceAccount:${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="projects/${PROJECT_ID}/roles/AppcircleGCSRole"
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_PREFIX}-agent-cache \
  --member="serviceAccount:${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="projects/${PROJECT_ID}/roles/AppcircleGCSRole"
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_PREFIX}-backup \
  --member="serviceAccount:${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="projects/${PROJECT_ID}/roles/AppcircleGCSRole"
gcloud storage buckets add-iam-policy-binding gs://${BUCKET_PREFIX}-publish \
  --member="serviceAccount:${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="projects/${PROJECT_ID}/roles/AppcircleGCSRole"
```

> üîí For tighter control, use `roles/storage.objectViewer` + `storage.objectCreator` instead of full `objectAdmin`.

Or if you created the custom role, replace the role like this:

```bash
gcloud projects add-iam-policy-binding ${PROJECT_ID} \
  --member="serviceAccount:${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="projects/${PROJECT_ID}/roles/AppcircleGCSRole"
```

### 7. Generate and Download Credentials

This is what your app will use to access the buckets:

```bash
gcloud iam service-accounts keys create appcircle-sa-key.json \
  --iam-account=${SERVICE_ACCOUNT_NAME}@${PROJECT_ID}.iam.gserviceaccount.com
```

> üîê Keep `appcircle-sa-key.json` safe. Use it as a **Google Application Credentials JSON**.

## Create a secret with the GCP credentials

Create a Kubernetes secret with the GCP credentials to be used by Appcircle Server.

:::caution
- Replace `appcircle` with the actual namespace where Appcircle Server will be installed.
- **Do not replace** the `appcircle-server-minio-connection` secret name as it's required by the Helm chart.
:::

- Convert the `appcircle-sa-key.json` file to base64:

```bash
ENCODED_CREDENTIALS=$(cat appcircle-sa-key.json | base64 -w 0)
```

- Create a Kubernetes secret with the GCP credentials:

```bash
kubectl create secret generic gcs-credentials \
  -n appcircle \
  --from-literal=gcs-credentials-base64="${ENCODED_CREDENTIALS}"
```

## Configure Appcircle Server to use GCP Cloud Storage

**Before** deploying the Appcircle Server Helm chart, you need to configure the Helm chart with a `values.yaml` file that includes the GCP Cloud Storage configuration.

```yaml
global:
  minio:
    url: https://storage.googleapis.com
    region: "us-east1"
    useHttp: "false"
    bucketPrefix: "appcircle-berkdoctest-"
resource:
  s3:
    clientProvider: "GCLOUD"
    cdnProvider: ""
    googleCredentialsSecretName: gcs-credentials
minio:
  enabled: false
```

:::caution
- Replace `https://storage.googleapis.com` with your [GCS endpoint](https://cloud.google.com/storage/docs/request-endpoints).
- Replace `us-east1` with your GCP region.
- Set `useHttp` to `true` only if you're using HTTP instead of HTTPS (not recommended for production).
:::

## Next Steps

After you have configured the Helm chart, you can head back to the [Installation](/self-hosted-appcircle/install-server/helm-chart/installation) page and continue with the installation process.

<NeedHelp />
